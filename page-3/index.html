<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"><title>Blog &middot; Hyeonil's Note</title><!--[if gt IE 8]><!----><style> article,aside,dialog,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}mark{background:#FF0;color:#000}template{display:none}*{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}html{line-height:1.65}body{color:#515151;background-color:#fff}a{text-decoration:none}img{display:block;max-width:100%;margin:0 0 1rem}img.lead{max-width:calc(100% + 2rem);width:calc(100% + 2rem);margin-left:calc(-1rem);margin-right:calc(-1rem)}h1,h2,h3,h4,h5,h6{margin-bottom:.5rem;font-weight:600;line-height:1.25;color:#313131;text-rendering:optimizeLegibility}h1{font-size:2rem}h2{margin-top:1rem;font-size:1.5rem}p{margin-top:0;margin-bottom:1rem}p.lead{font-size:1.25rem;font-weight:300}ul,ol,dl{margin-top:0;margin-bottom:1rem}hr{position:relative;margin:1.5rem 0;border:0;border-top:1px solid #eee;border-bottom:1px solid #fff}.container{max-width:38rem;padding-left:1rem;padding-right:1rem;margin-left:auto;margin-right:auto}.page-title,.post-title{color:#303030}.page-title,.post-title{margin-top:0}.post-date{display:block;margin-top:-.25rem;margin-bottom:1rem;color:#9a9a9a;font-weight:bold}.related{padding-top:2rem;padding-bottom:2rem}.related-posts{padding-left:0;list-style:none}.related-posts>li{margin-top:1rem}.related-posts>li>*{font-weight:normal}.message{margin-bottom:1rem;padding:1rem;color:#717171;background-color:#f9f9f9;margin-left:-1rem;margin-right:-1rem}body{padding-left:0.5rem}@media (min-width: 48em){html{font-size:16px}body{padding-left:0}}@media (min-width: 58em){html{font-size:18px}}.sr-only{display:none}.backdrop{display:none}.sidebar{position:relative;z-index:4;padding:2rem 1rem;color:rgba(255,255,255,0.75);background-color:#202020;text-align:left;background-size:cover;background-position:center center;min-height:640px;min-height:100vh;margin-left:-0.5rem}.sidebar a{color:#fff}.sidebar ul{list-style:none;padding-left:0}.sidebar-sticky{position:absolute;right:1rem;bottom:1rem;left:1rem}.sidebar-about>h1{color:#fff;font-size:2rem}.sidebar-nav-item{font-weight:bold;display:block;line-height:1.75;padding:.25rem .1rem;border-top:1px solid rgba(255,255,255,0.23)}.sidebar-social>ul{min-height:3.5rem}.sidebar::before{content:"";position:absolute;top:0;left:0;bottom:0;right:0;background:rgba(32,32,32,0.33);background:-moz-linear-gradient(bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 100%);background:-webkit-linear-gradient(bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 100%);background:linear-gradient(to bottom, rgba(32,32,32,0) 0%, rgba(32,32,32,0.5) 100%)}@media (min-width: 48em){.sidebar{position:fixed;top:0;left:0;bottom:0;width:18rem;margin-left:0}}.menu{display:block;padding:1.25rem 1.5rem;color:#9a9a9a;border-bottom:none;position:fixed;top:0;left:0;z-index:2}@media (min-width: 48em){.menu{position:absolute;left:-9999px}}@media (min-width: 48em){.menu:focus{left:19.5rem}}@media (min-width: 64em){.menu:focus{left:21.5rem}}.content{padding-top:4rem;padding-bottom:4rem}@media (min-width: 48em){.content{max-width:38rem;margin-left:20rem;margin-right:2rem;border-left:none}}@media (min-width: 64em){.content{margin-left:22rem;margin-right:4rem}}.me{float:right;width:6.5rem;margin-top:-4.8rem;margin-left:1rem;border-radius:100%;position:relative}@media (min-width: 38em){.me{width:7rem;margin-top:-5.05rem}}@media (min-width: 48em){.me{width:6.5rem;margin-top:-4.8rem}}@media (min-width: 58em){.me{width:7rem;margin-top:-5.05rem}}</style><noscript><link rel="stylesheet" href="/public/css/non-essentials.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab:700|PT+Serif:400,400italic,700,700italic"> </noscript><link rel="preload" href="/public/css/non-essentials.css" as="style" onload="this.rel='stylesheet'"><style> html { font-family: "PT Serif", Georgia, serif; } :focus { outline-color: #A85641; } .font-accent { font-family: "Roboto Slab", "PT Serif", Georgia, serif; } .content a, .related-posts li a:hover { color: #A85641; } ::selection { color: #fff; background: #A85641; } ::-moz-selection { color: #fff; background: #A85641; } .sidebar { background-image: url('/public/img/side.jpg'); }</style><!--<![endif]--><link rel="canonical" href="https://blog.nuti.pe.kr/page-3/" /><link rel="alternate" type="application/atom+xml" title="Hyeonil's Note Atom Feed" href="/atom.xml"><link rel="stylesheet" href="/public/css/asciidoctor.css"><link rel="stylesheet" href="/public/css/coderay.css"><link rel="stylesheet" href="/public/css/font-awesome.min.css"><link rel="stylesheet" href="/public/css/foundation.min.css"><link rel="stylesheet" href="/public/css/normalize.css"><link rel="stylesheet" href="/public/css/custom.css"> <script>!function(n,e){function t(n,e){n.onload=function(){this.onerror=this.onload=null,e(null,n)},n.onerror=function(){this.onerror=this.onload=null,e(new Error("Failed to load "+this.src),n)}}function o(n,e){n.onreadystatechange=function(){"complete"!=this.readyState&&"loaded"!=this.readyState||(this.onreadystatechange=null,e(null,n))}}n.isReady=!1,n.loadJSDeferred=function(a,r){function d(){n.isReady=!0;var d=e.createElement("script");d.src=a,r&&(("onload"in d?t:o)(d,r),d.onload||t(d,r));var i=e.getElementsByTagName("script")[0];i.parentNode.insertBefore(d,i)}n.isReady?d():n.addEventListener?n.addEventListener("load",d,!1):n.attachEvent?n.attachEvent("onload",d):n.onload=d}}(window,document); </script> <!--[if lt IE 9]> <script src="https://unpkg.com/html5shiv/dist/html5shiv.min.js"></script> <![endif]--><body> <span class="sr-only">Jump to:</span> <a id="_menu" class="menu" href="#_asidebar"> <span>☰</span> <span class="sr-only">Menu</span> </a><main class="content container" role="main"><article id="post-2018/07/14/spock-framework" class="post" role="article"><h1 class="post-title"> <a href="/2018/07/14/spock-framework/"> Spock Framework </a></h1><div class="post-date"> <time datetime="2018-07-14T00:00:00+00:00">2018/07/14/</time> <span>on <a href="/tag/spec/">Specification</a><span>, </span><a href="/tag/java/">Java</a></span></div><hr/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="sect1"><h2 id="spock_framework"><a class="link" href="#spock_framework">1. Spock Framework?</a></h2><div class="sectionbody"><div class="paragraph"><p><code>Spock Framework</code>는 <code>Groovy</code> 언어에서 동작하는 <code>명세</code> 프레임워크로 <code>BDD</code>를 편하게할 수 있도록 도와준다. <code>Spock</code>은 <code>Java</code>와 <code>Groovy</code> 어플리케이션을 위한 명세 프레임워크로 <code>Groovy(DSL)</code>로 작성하므로 간결하고 직관적인 장점이 있다. 또한, 기존의 <code>Java</code>의 <code>JUnit</code>, <code>Hamcrest</code>, <code>Mockito</code>를 전부 다 학습하는 것보다 손쉽게 학습할 수 있고, <code>Mock</code>, <code>Stub</code>, <code>Spy</code>등 사용이 편리하고 명세를 작성하기 편리하다. <code>Java</code>와 <code>Groovy</code> 어플리케이션을 위한 프레임워크이므로 <code>Java</code>환경에서도 사용할 수 있다.</div></div></div><div class="sect1"><h2 id="lifecycle"><a class="link" href="#lifecycle">2. Lifecycle</a></h2><div class="sectionbody"><div class="ulist"><ul><li><p>setup: 메소드 실행 전에 실행(given)<li><p>when: 행위에 대한 명세를 작성<li><p>then: 행위에 대한 예측을 작성<li><p>expect: 행위에 대한 명세와 예측을 작성(when + then)<li><p>cleanup: 메소드 실행 후에 실행<li><p>where: 여러 값에 대해 반복행위를 할 때 작성</ul></div><div class="imageblock text-center"><div class="content"> <img src="/public/images/spock/spock-lifecycle.png" alt="spock lifecycle"></div><div class="title">Figure 1. Spock Lifecycle</div></div><div class="paragraph"><p>출처: <a href="http://spockframework.org/spock/docs/1.1/spock_primer.html" class="bare">http://spockframework.org/spock/docs/1.1/spock_primer.html</a></div></div></div><div class="sect1"><h2 id="example"><a class="link" href="#example">3. Example</a></h2><div class="sectionbody"><div class="paragraph"><p><a href="https://github.com/hyeonil/spock-examples">기본 예시</a></div><div class="paragraph"><p>앞서 <code>BDD</code> <a href="http://blog.nuti.pe.kr/2018/07/14/bdd/">포스트에서 작성한 예시</a>를 <code>Spock</code>으로 변환하게 되면 아래와 같다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="groovy"><span class="keyword">package</span> kr.pe.nuti.home.api.service.todo

<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.domain.todo.TodoItem</span>
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.enumeration.todo.TodoState</span>
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.exception.todo.IllegalStateChangeException</span>
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.repository.todo.TodoItemRepository</span>
<span class="keyword">import</span> <span class="include">spock.lang.Issue</span>
<span class="keyword">import</span> <span class="include">spock.lang.Narrative</span>
<span class="keyword">import</span> <span class="include">spock.lang.See</span>
<span class="keyword">import</span> <span class="include">spock.lang.Specification</span>
<span class="keyword">import</span> <span class="include">spock.lang.Title</span>

<span class="annotation">@Title</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">Todo Item의 상태를 변경한다.</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Narrative</span>(<span class="string"><span class="delimiter">&quot;&quot;&quot;</span><span class="content">
Todo Management System을 사용하는 사용자가
Todo Item의 상태관리를 위해서
각각의 Todo Item의 상태를 변경할 수 있다.
상태 변경은 Todo &gt; Doing, Doing &gt; Done,
Done &gt; Doing, Doing &gt; Todo로만 할 수 있다.
</span><span class="delimiter">&quot;&quot;&quot;</span></span>)
<span class="type">class</span> <span class="class">TodoServiceStateChangeSpec</span> <span class="directive">extends</span> Specification {

  TodoService service
  <span class="keyword">def</span> todoItemRepository

  <span class="keyword">def</span> <span class="function">setup</span>() {
    todoItemRepository = Mock(TodoItemRepository)
    service = Spy(TodoService)
    service.todoItemRepository = todoItemRepository
  }

  <span class="annotation">@See</span>([<span class="string"><span class="delimiter">&quot;</span><span class="content">https://github.com/hyeonil/smart-home-api/issues/6</span><span class="delimiter">&quot;</span></span>])
  <span class="annotation">@Issue</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#6</span><span class="delimiter">&quot;</span></span>)
  <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo상태를 Doing상태로 변경하면 상태가 변경된다.</span><span class="delimiter">&quot;</span></span>() {
    <span class="key">given</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo 상태의 Todo Item</span><span class="delimiter">&quot;</span></span>
    TodoItem savedItem = <span class="keyword">new</span> TodoItem([<span class="key">idx</span>: <span class="integer">1L</span>, <span class="key">state</span>: TodoState.TODO])
    TodoItem changedItem = <span class="keyword">new</span> TodoItem([<span class="key">idx</span>: <span class="integer">1L</span>, <span class="key">state</span>: TodoState.DOING])
    todoItemRepository.findById(_) &gt;&gt; Optional.of(savedItem)
    todoItemRepository.save(_) &gt;&gt;  changedItem

    TodoItem item = <span class="keyword">new</span> TodoItem([<span class="key">idx</span>: <span class="integer">1L</span>])

    <span class="key">when</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo Item의 상태를 Doing으로 변경한다.</span><span class="delimiter">&quot;</span></span>
    <span class="keyword">def</span> result = service.changeState(item, TodoState.DOING)

    <span class="key">then</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo Item의 상태가 Doing으로 변경된다.</span><span class="delimiter">&quot;</span></span>
    <span class="integer">1</span> * service.getItem(_)
    result.state == TodoState.DOING
  }

  <span class="annotation">@See</span>([<span class="string"><span class="delimiter">&quot;</span><span class="content">https://github.com/hyeonil/smart-home-api/issues/6</span><span class="delimiter">&quot;</span></span>])
  <span class="annotation">@Issue</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">#6</span><span class="delimiter">&quot;</span></span>)
  <span class="keyword">def</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo상태를 Done상태로 변경하면 상태가 변경되지 않고 예외사항이 발생한다.</span><span class="delimiter">&quot;</span></span>() {
    <span class="key">given</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo 상태의 Todo Item</span><span class="delimiter">&quot;</span></span>
    TodoItem savedItem = <span class="keyword">new</span> TodoItem([<span class="key">idx</span>: <span class="integer">1L</span>, <span class="key">state</span>: TodoState.TODO])
    todoItemRepository.findById(_) &gt;&gt; Optional.of(savedItem)

    TodoItem item = <span class="keyword">new</span> TodoItem([<span class="key">idx</span>: <span class="integer">1L</span>])

    <span class="key">when</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo Item의 상태를 Done으로 변경한다.</span><span class="delimiter">&quot;</span></span>
    service.changeState(item, TodoState.DONE)

    <span class="key">then</span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">Todo Item의 상태가 변경되지 않고 예외사항이 발생한다.</span><span class="delimiter">&quot;</span></span>
    <span class="integer">1</span> * service.getItem(_)
    thrown(IllegalStateChangeException)
  }
}</code></pre></div></div></div></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></article><br/><article id="post-2018/07/14/bdd" class="post" role="article"><h1 class="post-title"> <a href="/2018/07/14/bdd/"> BDD </a></h1><div class="post-date"> <time datetime="2018-07-14T00:00:00+00:00">2018/07/14/</time> <span>on <a href="/tag/spec/">Specification</a></span></div><hr/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="sect1"><h2 id="bddbehavior_driven_development란"><a class="link" href="#bddbehavior_driven_development란">1. BDD(Behavior-Driven Development)란?</a></h2><div class="sectionbody"><div class="paragraph"><p><code>BDD</code>는 <code>TDD</code>에서 파생된 개발 방법론으로 테스트에 대한 집중보다는 명세와 행위에 대해 비중을 두고 있다.</div><div class="sect2"><h3 id="tdd"><a class="link" href="#tdd">1.1. TDD</a></h3><div class="imageblock text-center"><div class="content"> <img src="/public/images/bdd/tdd.jpg" alt="tdd"></div><div class="title">Figure 1. TDD</div></div><div class="paragraph"><p><code>TDD</code>는 <code>Test Case(이하 TC)</code>를 작성하고 실패를 확인 후 실제 비즈니스 코드를 작성, <code>TC</code> 성공확인을 하나의 반복주기로 잡고, 이를 반복해서 진행하는 것을 요구한다. 하지만 <code>TC</code>를 작성하는데 의문점이 있다. 코드가 없는데 무엇을 테스트할 것인가? <code>TDD</code>를 보면 무엇을 테스하는지에 대한 명시는 되어있지 않다. 또한, 보통 테스트라 하면 제품이 나오면 그 제품을 사용해보면서 제대로 작동하는지 확인을 해보는 과정인데, 제품이 나오지도 않았는데 테스트를 한다라는 것부터 모순이 생긴다. 이를 개선한 것이 <code>BDD</code>라고 생각을 한다.</div></div><div class="sect2"><h3 id="bddbehavior_driven_development"><a class="link" href="#bddbehavior_driven_development">1.2. BDD(Behavior-Driven Development)</a></h3><div class="paragraph"><p><code>BDD</code>는 위에서 언급한바와 같이 <code>TDD</code>에서 파생된 개발방법론이고, 코드의 구현과 테스트 보다는 행위(동작, 명세)에 집중하고 있다. <code>BDD</code>에서는 기능의 <code>TC</code>를 작성하는 것이 아닌 명세를 작성하는 것이고, 요구사항 분석 후 기능 설계 및 명세작성, 코드구현의 순서로 진행을 하게된다.</div><div class="paragraph"><p><code>BDD</code>에서 <code>테스트(Test)</code> 라는 단어를 사용하지 않고 <code>명세(Specification)</code>를 사용함으로써 많은 것이 바뀌게 된다. <code>TDD</code>에서는 <code>테스트</code>라는 단어를 사용하게 되어 혼란과 모순을 가지게 되었는데, <code>BDD</code>에서는 이를 <code>명세</code>라는 단어로 사용함으로써, 제품이 생산되기 전에 제품에 대한 명세를 작성하게 되는 것이므로 이에 대한 모순이 사라지게 된다.</div></div></div></div><div class="sect1"><h2 id="bdd_template"><a class="link" href="#bdd_template">2. BDD Template</a></h2><div class="sectionbody"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="plain">Title: 스토리에대한 제목을 간략하고 명확하게 작성
User Story
  Who 누가
  Why 왜
  What 무엇을 하는지
Scenario
  Given 어떤 값이 주어졌을 때
  When 어떤 행위를 하게 되면
  Then 어떤 결과를 도출한다</code></pre></div></div></div></div><div class="sect1"><h2 id="bdd_example"><a class="link" href="#bdd_example">3. BDD Example</a></h2><div class="sectionbody"><div class="paragraph"><p>할일을 관리할 수 있는 프로그램을 만든다고 가정을 한다. 그렇다면 기획자 혹은 개발자는 고객과 커뮤니케이션을 하며 프로그램에 대한 요구사항을 수집하게 된다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="plain">할일을 관리할 수 있는 시스템을 개발한다.
Todo Item을 등록/수정/삭제 할 수 있다.
Todo/Doing/Done 할 수 있고 Archive할 수 있어야 한다.
Todo Item을 등록할 때 Todo 상태로 시작한다.
상태변경을 할 수 있고 상태 변경은
Todo &gt; Doing, Doing &gt; Done, Done &gt; Doing, Doing &gt; Todo로만 할 수 있다.
Archive는 Todo/Doing/Done 모든 상태에서 가능하다.
목록보기/상세보기 기능을 포함한다.
페이징 기능은 스펙에서 제외하고 현재 스펙에서는 전체 목록을 한번에 조회한다.</code></pre></div></div><div class="paragraph"><p>수집한 요구항이 위와 같다고 하면 아래 그림과 같은 <code>Use Case Diagram</code>과 <code>Class Diagram</code>을 그릴 수 있다.</div><div class="imageblock text-center"><div class="content"> <img src="/public/images/bdd/use-case-diagram.png" alt="use case diagram"></div><div class="title">Figure 2. Use Case Diagram</div></div><div class="imageblock text-center"><div class="content"> <img src="/public/images/bdd/class-diagram.png" alt="class diagram"></div><div class="title">Figure 3. Class Diagram</div></div><div class="paragraph"><p>위 예시에서 <strong>상태변경</strong>을 통해 명세작성 예시를 진행하도록 하겠다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="plain">Title: Todo Item의 상태를 변경한다.

User Story
Who: Todo Management System을 사용하는 사용자가
Why: Todo Item의 상태관리를 위해서
What: 각각의 Todo Item의 상태를 변경할 수 있다.
      상태 변경은 Todo &gt; Doing, Doing &gt; Done,
      Done &gt; Doing, Doing &gt; Todo로만 할 수 있다.

Scenario 1: Todo상태를 Doing상태로 변경하면 상태가 변경된다.
Scenario 2: Doing상태를 Done상태로 변경하면 상태가 변경된다.
Scenario 3: Done상태를 Doing상태로 변경하면 상태가 변경된다.
Scenario 4: Doing상태를 Todo상태로 변경하면 상태가 변경된다.
Scenario 5: Todo상태를 Done상태로 변경하면 상태가 변경되지 않고 예외사항이 발생한다.
Scenario 6: Done상태를 Todo상태로 변경하면 상태가 변경되지 않고 예외사항이 발생한다.</code></pre></div></div><div class="paragraph"><p>일반 글로 위와 같은 명세를 작성할 수 있고 아래와 같이 코드로 명세를 작성할 수 있다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.service.todo</span>;

<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.application.Application</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.application.JpaConfiguration</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.application.WebConfiguration</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.domain.todo.TodoItem</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.enumeration.todo.TodoState</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.exception.todo.IllegalStateChangeException</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.repository.todo.TodoItemRepository</span>;
<span class="keyword">import</span> <span class="include">org.junit.Assert</span>;
<span class="keyword">import</span> <span class="include">org.junit.Before</span>;
<span class="keyword">import</span> <span class="include">org.junit.Test</span>;
<span class="keyword">import</span> <span class="include">org.junit.runner.RunWith</span>;
<span class="keyword">import</span> <span class="include">org.mockito.InjectMocks</span>;
<span class="keyword">import</span> <span class="include">org.mockito.Mock</span>;
<span class="keyword">import</span> <span class="include">org.mockito.MockitoAnnotations</span>;
<span class="keyword">import</span> <span class="include">org.mockito.Spy</span>;
<span class="keyword">import</span> <span class="include">org.springframework.beans.factory.annotation.Autowired</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.ContextConfiguration</span>;
<span class="keyword">import</span> <span class="include">org.springframework.test.context.junit4.SpringJUnit4ClassRunner</span>;

<span class="keyword">import</span> <span class="include">java.util.Optional</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.hamcrest.Matchers.is</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.ArgumentMatchers.any</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.Mockito.verifyNoMoreInteractions</span>;
<span class="keyword">import</span> <span class="include">static</span> <span class="include">org.mockito.Mockito.when</span>;

<span class="comment">/**
 * Title: Todo Item의 상태를 변경한다.
 * User Story:
 * Todo Management System을 사용하는 사용자가
 * Todo Item의 상태관리를 위해서
 * 각각의 Todo Item의 상태를 변경할 수 있다.
 * 상태 변경은 Todo &gt; Doing, Doing &gt; Done,
 * Done &gt; Doing, Doing &gt; Todo로만 할 수 있다.
 */</span>
<span class="annotation">@RunWith</span>(SpringJUnit4ClassRunner.class)
<span class="annotation">@ContextConfiguration</span>(classes = {JpaConfiguration.class, WebConfiguration.class, Application.class})
<span class="directive">public</span> <span class="type">class</span> <span class="class">TodoServiceStateChangeTest</span> {

  <span class="annotation">@Mock</span>
  <span class="directive">private</span> TodoItemRepository todoItemRepository;

  <span class="annotation">@Autowired</span>
  <span class="annotation">@Spy</span>
  <span class="annotation">@InjectMocks</span>
  <span class="directive">private</span> TodoService service;

  <span class="annotation">@Before</span>
  <span class="directive">public</span> <span class="type">void</span> setup() {
    MockitoAnnotations.initMocks(<span class="local-variable">this</span>);
  }

  <span class="comment">/**
   * Todo상태를 Doing상태로 변경하면 상태가 변경된다.
   * @throws Exception
   */</span>
  <span class="annotation">@Test</span>
  <span class="directive">public</span> <span class="type">void</span> testStateChangeFromTodoToDoing() <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="comment">// given Todo 상태의 Todo Item</span>
    TodoItem savedItem = <span class="keyword">new</span> TodoItem();
    savedItem.setIdx(<span class="integer">1L</span>);
    savedItem.setState(TodoState.TODO);
    TodoItem changedItem = <span class="keyword">new</span> TodoItem();
    changedItem.setIdx(<span class="integer">1L</span>);
    changedItem.setState(TodoState.DOING);
    when(todoItemRepository.save(any(TodoItem.class))).thenReturn(changedItem);
    when(todoItemRepository.findById(<span class="integer">1L</span>)).thenReturn(Optional.of(savedItem));

    TodoItem item = <span class="keyword">new</span> TodoItem();
    item.setIdx(<span class="integer">1L</span>);

    <span class="comment">// when Todo Item의 상태를 Doing으로 변경한다.</span>
    TodoItem result = service.changeState(item, TodoState.DOING);

    <span class="comment">// then Todo Item의 상태가 Doing으로 변경된다.</span>
    Assert.assertThat(result.getState(), is(TodoState.DOING));
    verifyNoMoreInteractions(service);
  }

  <span class="comment">/**
   * Todo상태를 Done상태로 변경하면 상태가 변경되지 않고 예외사항이 발생한다.
   * @throws Exception
   */</span>
  <span class="annotation">@Test</span>(expected = IllegalStateChangeException.class)
  <span class="directive">public</span> <span class="type">void</span> testStateChangeFromTodoToDoneThrownException() <span class="directive">throws</span> <span class="exception">Exception</span> {
    <span class="keyword">try</span> {
      <span class="comment">// given Todo 상태의 Todo Item</span>
      TodoItem savedItem = <span class="keyword">new</span> TodoItem();
      savedItem.setIdx(<span class="integer">1L</span>);
      savedItem.setState(TodoState.TODO);
      TodoItem changedItem = <span class="keyword">new</span> TodoItem();
      changedItem.setIdx(<span class="integer">1L</span>);
      changedItem.setState(TodoState.DOING);
      when(todoItemRepository.findById(any(<span class="predefined-type">Long</span>.class))).thenReturn(Optional.of(savedItem));
      when(todoItemRepository.save(any(TodoItem.class))).thenReturn(changedItem);

      TodoItem item = <span class="keyword">new</span> TodoItem();
      item.setIdx(<span class="integer">1L</span>);

      <span class="comment">// when Todo Item의 상태를 Done으로 변경한다.</span>
      service.changeState(item, TodoState.DONE);

      <span class="comment">// then Todo Item의 상태가 변경되지 않고 예외사항이 발생한다.</span>
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
      verifyNoMoreInteractions(service);
      <span class="keyword">throw</span> e;
    }
  }
}</code></pre></div></div><div class="paragraph"><p><a href="https://slides.com/hyeoniljeong/bdd_spock_framework">관련 slide 자료</a></div></div></div><div class="sect1"><h2 id="references"><a class="link" href="#references">4. References</a></h2><div class="sectionbody"><div class="ulist"><ul><li><p><a href="https://en.wikipedia.org/wiki/Behavior-driven_development" class="bare">https://en.wikipedia.org/wiki/Behavior-driven_development</a><li><p><a href="https://en.wikipedia.org/wiki/User_story" class="bare">https://en.wikipedia.org/wiki/User_story</a></ul></div></div></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></article><br/><article id="post-2018/06/13/spring-aop" class="post" role="article"><h1 class="post-title"> <a href="/2018/06/13/spring-aop/"> Spring AOP(Aspect Oriented Programming) </a></h1><div class="post-date"> <time datetime="2018-06-13T00:00:00+00:00">2018/06/13/</time> <span>on <a href="/tag/spring/">Spring</a><span>, </span><a href="/tag/java/">Java</a></span></div><hr/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="sect1"><h2 id="개요"><a class="link" href="#개요">1. 개요</a></h2><div class="sectionbody"><div class="admonitionblock note"><table><tr><td class="icon"> <i class="fa icon-note" title="Note"></i><td class="content"><div class="paragraph"><p><code>AOP</code>는 스프링의 기반 기술 중 하나로 이해하기 힘든 용어와 개념을 가졌다. <code>AOP</code>는 자바의 <code>Reflection API</code>를 활용해서 구현을 하게되고, 주로 비즈니스 요구사항이 아닌 부분들을 처리하기 위해 사용한다.</div></table></div></div></div><div class="sect1"><h2 id="reflection_api"><a class="link" href="#reflection_api">2. Reflection API</a></h2><div class="sectionbody"><div class="imageblock text-center"><div class="content"> <img src="/public/images/aop/jvm-architecture.jpg" alt="jvm architecture"></div><div class="title">Figure 1. JVM Architecture</div></div><div class="paragraph"><p>자바의 Reflection API는 컴파일 레벨에서 실행될 클래스를 정하는 것이 아닌, 런타임에 실행할 클래스 파일을 정하게 할 수 있다. 또한, 런타임에서 클래스의 공개되지 않은 필드에 대한 정보를 볼 수 있고 조작할 수 있다.</div><div class="paragraph"><p>주로 JDBC나 MyBatis에서 많이 사용한다. 예시는 아래와 같다.</div><div class="sect2"><h3 id="reflection_api_example"><a class="link" href="#reflection_api_example">2.1. Reflection API Example</a></h3><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.annotation</span>;

<span class="keyword">import</span> <span class="include">java.lang.annotation</span>.*;

<span class="annotation">@Inherited</span>
<span class="annotation">@Documented</span>
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({
    <span class="predefined-type">ElementType</span>.METHOD
})
<span class="directive">public</span> <span class="annotation">@interface</span> LogDetail {
}</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.annotation</span>;

<span class="keyword">import</span> <span class="include">java.lang.annotation</span>.*;

<span class="annotation">@Inherited</span>
<span class="annotation">@Documented</span>
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({
    <span class="predefined-type">ElementType</span>.TYPE
})
<span class="directive">public</span> <span class="annotation">@interface</span> TrackLog {
}</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.util</span>;

<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.annotation.TrackLog</span>;

<span class="keyword">import</span> <span class="include">java.lang.reflect.Field</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">kr.pe.nuti.home.api.core.util.BooleanUtil.not</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">LogUtil</span> {

  <span class="directive">private</span> LogUtil() {
    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="exception">IllegalAccessError</span>();
  }

  <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> argValues(<span class="predefined-type">Object</span> arg, <span class="type">int</span> depth) <span class="directive">throws</span> <span class="exception">IllegalAccessException</span> {
    <span class="keyword">if</span> (arg == <span class="predefined-constant">null</span>) {
      <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">null</span><span class="delimiter">&quot;</span></span>;
    }
    <span class="directive">final</span> <span class="predefined-type">Class</span>&lt;?&gt; cls = arg.getClass();

    <span class="keyword">if</span> (cls.isPrimitive() || cls.isAssignableFrom(<span class="predefined-type">String</span>.class) || not(cls.isAnnotationPresent(TrackLog.class))) {
      <span class="keyword">return</span> arg.toString();
    }

    <span class="predefined-type">StringBuilder</span> builder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();
    builder.append(whiteSpace(depth)).append(cls.getName()).append(<span class="string"><span class="delimiter">&quot;</span><span class="content">{</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);

    <span class="keyword">for</span> (<span class="predefined-type">Field</span> field : cls.getDeclaredFields()) {
      field.setAccessible(<span class="predefined-constant">true</span>);
      <span class="predefined-type">Object</span> fieldObj = field.get(arg);
      builder.append(whiteSpace(depth + <span class="integer">1</span>))
          .append(field.getName())
          .append(<span class="string"><span class="delimiter">&quot;</span><span class="content"> : </span><span class="delimiter">&quot;</span></span>)
          .append(argValues(fieldObj, depth + <span class="integer">1</span>))
          .append(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    }

    builder.append(<span class="string"><span class="delimiter">&quot;</span><span class="content">}</span><span class="delimiter">&quot;</span></span>);

    <span class="keyword">return</span> builder.toString();
  }

  <span class="directive">public</span> <span class="directive">static</span> <span class="predefined-type">String</span> whiteSpace(<span class="type">int</span> depth) {
    <span class="directive">final</span> <span class="predefined-type">String</span> appender = <span class="string"><span class="delimiter">&quot;</span><span class="content">  </span><span class="delimiter">&quot;</span></span>;
    <span class="predefined-type">StringBuilder</span> builder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; depth; i++) {
      builder.append(appender);
    }

    <span class="keyword">return</span> builder.toString();
  }
}</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.handler</span>;

<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.annotation.LogDetail</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.util.LogUtil</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;

<span class="keyword">import</span> <span class="include">java.lang.reflect.InvocationHandler</span>;
<span class="keyword">import</span> <span class="include">java.lang.reflect.Method</span>;

<span class="keyword">import</span> <span class="include">static</span> <span class="include">kr.pe.nuti.home.api.core.util.BooleanUtil.not</span>;

<span class="directive">public</span> <span class="type">class</span> <span class="class">LogDetailMethodInvocationHandler</span> <span class="directive">implements</span> <span class="predefined-type">InvocationHandler</span> {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(LogDetailMethodInvocationHandler.class);

  <span class="directive">private</span> <span class="predefined-type">Object</span> target;

  <span class="directive">public</span> LogDetailMethodInvocationHandler(<span class="predefined-type">Object</span> target) {
    <span class="local-variable">this</span>.target = target;
  }

  <span class="annotation">@Override</span>
  <span class="directive">public</span> <span class="predefined-type">Object</span> invoke(<span class="predefined-type">Object</span> proxy, <span class="predefined-type">Method</span> method, <span class="predefined-type">Object</span><span class="type">[]</span> args) <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
    <span class="keyword">if</span> (not(method.isAnnotationPresent(LogDetail.class))) {
      <span class="keyword">return</span> method.invoke(target, args);
    }
    <span class="predefined-type">String</span> className = method.getDeclaringClass().getName();
    <span class="predefined-type">String</span> methodName = method.getName();
    <span class="predefined-type">StringBuilder</span> argBuilder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

    <span class="keyword">for</span> (<span class="predefined-type">Object</span> arg : args) {
      argBuilder.append(LogUtil.argValues(arg, <span class="integer">0</span>))
          .append(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    }
    <span class="predefined-type">String</span> argString = argBuilder.toString();

    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoke method {}${}</span><span class="delimiter">&quot;</span></span>, className, methodName);
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">method arguments: {}</span><span class="delimiter">&quot;</span></span>, argString);

    <span class="predefined-type">Object</span> result  = method.invoke(target, args);

    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">finish the method {}${}</span><span class="delimiter">&quot;</span></span>, className, methodName);

    <span class="keyword">return</span> result;
  }
}</code></pre></div></div><div class="paragraph"><p>위 예시는 <code>LogDetail</code>이라는 어노테이션을 가진 메소드에 대해서 해당 메소드의 파라미터 정보를 상세하게 로깅하는 것이다. 런타임에서 메소드의 정보를 분석해서 어노테이션 표기 여부에 따라 로그를 남기고 메소드를 실행시키게 된다. 또한, <code>LogUtil.argValues</code>는 Object의 정보를 상세하게 분석해서 Object 내부의 필드정보를 보여줄 수 있도록 되어있다.</div><div class="paragraph"><p><code>Reflection API</code>는 이런식으로 컴파일 타임에 어떤 클래스의 인스턴스가 실행될 지 알 수 없는 경우에 런타임에서 클래스정보를 분석하고 실행할 수 있도록 할 때 사용한다.</div></div></div></div><div class="sect1"><h2 id="proxy_pattern"><a class="link" href="#proxy_pattern">3. Proxy Pattern</a></h2><div class="sectionbody"><div class="imageblock text-center"><div class="content"> <img src="/public/images/aop/proxy_pattern.png" alt="proxy pattern"></div><div class="title">Figure 2. Proxy Pattern</div></div><div class="ulist"><ul><li><p>클라이언트가 실제 사용하려 하는 기능에 부가적인 기능을 더해서 자신이 핵심 기능인 척 위장하는 것<li><p>타겟은 프록시가 있는지 알아서는 안된다.<li><p>타겟의 기능을 확장 및 접근 방법을 제어할 수 있는 유용한 방법<li><p>특정 Object에 대한 접근을 제어<li><p>대상이 되는 Object의 생성에 관여를 하기도 함<div class="ulist"><ul><li><p>생성이 복잡한 경우<li><p>당장 생성이 필요하지 않은 경우에 바로 생성하지 않고, 필요한 시기에 생성</ul></div><li><p>원격 Object를 이용하는 경우에 사용<div class="ulist"><ul><li><p>RMI<li><p>EJB</ul></div><li><p>대상이 되는 Object에 대한 접근권한을 제어하기 위해 사용</ul></div></div></div><div class="sect1"><h2 id="decorator_pattern"><a class="link" href="#decorator_pattern">4. Decorator Pattern</a></h2><div class="sectionbody"><div class="imageblock text-center"><div class="content"> <img src="/public/images/aop/decorator_pattern.png" alt="decorator pattern"></div><div class="title">Figure 3. Decorator Pattern</div></div><div class="ulist"><ul><li><p>대상이 되는 Object에 부가적인 기능을 부여하기 위해 사용<li><p>컴파일 시점에 어떤 방법과 순서로 연결되어 사용하는지 정해지지 않음<li><p>InputStream, OutputStream</ul></div><div class="sect2"><h3 id="프록시_패턴과의_차이"><a class="link" href="#프록시_패턴과의_차이">4.1. 프록시 패턴과의 차이</a></h3><div class="ulist"><ul><li><p>프록시는 어떤 오브젝트를 사용하기 위해 대리인 역할을 맡은 오브젝트를 사용하는 방법을 총칭<li><p>프록시패턴 프록시를 사용하는 방법 중 타겟에 대한 접근 방법을 제어하려는 목적<li><p>타겟을 생성하기 복잡하거나 당장 필요하지 않은 경우에 타겟을 바로 생성하지 않고 프록시를 사용<li><p>실제 타겟을 사용할 때 타겟을 생성(Lazy)<li><p>기능에 대한 접근 권한을 제어하는 목적으로도 사용(읽기/쓰기 권한)<li><p>자신이 만들거나 접근할 타겟을 알고있는 경우가 많음</ul></div></div></div></div><div class="sect1"><h2 id="proxy"><a class="link" href="#proxy">5. Proxy</a></h2><div class="sectionbody"><div class="ulist"><ul><li><p>Client와 사용 대상 Object 사이에서 대리 역할을 하는 Object<li><p>대상 Object의 핵심 기능에 부가적인 기능을 추가<li><p>대상 Object는 Proxy Object의 존재 여부를 모름<li><p>대상 Object를 Target 또는 Real Object라고 부름</ul></div></div></div><div class="sect1"><h2 id="dynamic_proxy"><a class="link" href="#dynamic_proxy">6. Dynamic Proxy</a></h2><div class="sectionbody"><div class="imageblock text-center"><div class="content"> <img src="/public/images/aop/dynamic-proxy.jpg" alt="dynamic proxy"></div><div class="title">Figure 4. Dynamic Proxy</div></div><div class="ulist"><ul><li><p>프록시는 매 Class, Method마다 Proxy를 정의해주어야 한다는 단점이 존재<li><p>JAVA의 Reflection API를 통해 Runtime에 동적으로 Proxy하도록 함</ul></div></div></div><div class="sect1"><h2 id="aop"><a class="link" href="#aop">7. AOP</a></h2><div class="sectionbody"><div class="imageblock text-center"><div class="content"> <img src="/public/images/aop/aop.png" alt="aop"></div><div class="title">Figure 5. AOP</div></div><div class="ulist"><ul><li><p>Advice<div class="ulist"><ul><li><p>타겟이 필요 없는 순수한 부가 기능<li><p>스프링에서는 부가기능을 제공하는 Object를 Advice라고 부름</ul></div><li><p>Pointcut<div class="ulist"><ul><li><p>부가기능 적용 대상 선정 방법<li><p>스프링에서는 메소드 선정 알고리즘을 담은 Object를 Pointcut이라고 부름</ul></div><li><p>Advisor<div class="ulist"><ul><li><p>Pointcut + Advice</ul></div><li><p>Join Point<div class="ulist"><ul><li><p>Advice가 적용될 수 있는 위치</ul></div><li><p>Aspect<div class="ulist"><ul><li><p>독립적인 모듈화가 불가능한 모듈<li><p>그 자체로 핵심 기능을 담고 있지는 않지만, 어플리케이션을 구성하는 중요한 한 가지 요소이고, 핵심 기능에 부가되어 의미를 갖는 특별한 모듈</ul></div><li><p>핵심적인 기능에서 부가적인 기능을 분리해서 Aspect라는 독특한 모듈로 만들어 설계하고 개발하는 방법<li><p>객체지향을 좀 더 편하고 객체지향답게 사용할 수 있도록 하는 개념</ul></div></div></div><div class="sect1"><h2 id="aop_example"><a class="link" href="#aop_example">8. AOP Example</a></h2><div class="sectionbody"><div class="sect2"><h3 id="expression"><a class="link" href="#expression">8.1. Expression</a></h3><div class="paragraph"><p>execution([접근제한자 패턴] 타입패턴 [타입패턴.]이름패턴 (타입패턴 | “..}, …) [throws 예외 패턴])</div><div class="paragraph"><p>ex) public int springbook.learningtest.spring.pointcut.Target.mins(int, int) throws java.lang.RuntimeException</div><div class="ulist"><ul><li><p>public<div class="ulist"><ul><li><p>접근 제한자, 생략 가능</ul></div><li><p>int<div class="ulist"><ul><li><p>리턴 값의 타입을 나타내는 패턴</ul></div><li><p>springbook.learningtest.spring.pointcut.Target<div class="ulist"><ul><li><p>패키지 및 클래스 이름 패턴</ul></div><li><p>minus<div class="ulist"><ul><li><p>메소드 이름 패턴</ul></div><li><p>(int, int)<div class="ulist"><ul><li><p>메소드 파리미터 패턴</ul></div><li><p>throws java.lang.RuntimeException<div class="ulist"><ul><li><p>예외 이름 패턴</ul></div></ul></div><div class="paragraph"><p><a href="https://docs.spring.io/spring/docs/5.0.0.RELEASE/spring-framework-reference/core.html#aop-pointcuts">참고링크</a></div></div><div class="sect2"><h3 id="example_code"><a class="link" href="#example_code">8.2. Example Code</a></h3><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.annotation</span>;

<span class="keyword">import</span> <span class="include">java.lang.annotation</span>.*;

<span class="annotation">@Inherited</span>
<span class="annotation">@Documented</span>
<span class="annotation">@Retention</span>(<span class="predefined-type">RetentionPolicy</span>.RUNTIME)
<span class="annotation">@Target</span>({
    <span class="predefined-type">ElementType</span>.METHOD
})
<span class="directive">public</span> <span class="annotation">@interface</span> LogDetail {

}</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">kr.pe.nuti.home.api.core.aspect</span>;

<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.annotation.LogDetail</span>;
<span class="keyword">import</span> <span class="include">kr.pe.nuti.home.api.core.util.LogUtil</span>;
<span class="keyword">import</span> <span class="include">org.aspectj.lang.ProceedingJoinPoint</span>;
<span class="keyword">import</span> <span class="include">org.aspectj.lang.annotation.Around</span>;
<span class="keyword">import</span> <span class="include">org.aspectj.lang.annotation.Aspect</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.Logger</span>;
<span class="keyword">import</span> <span class="include">org.slf4j.LoggerFactory</span>;
<span class="keyword">import</span> <span class="include">org.springframework.stereotype.Component</span>;

<span class="annotation">@Aspect</span>
<span class="annotation">@Component</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">LogDetailAspect</span> {

  <span class="directive">private</span> <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = LoggerFactory.getLogger(LogDetailAspect.class);

  <span class="annotation">@Around</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">execution(* kr.pe.nuti.home.api..*.*(..)) &amp;&amp; @annotation(logDetail)</span><span class="delimiter">&quot;</span></span>)
  <span class="directive">public</span> <span class="predefined-type">Object</span> aroundTargetObject(ProceedingJoinPoint joinPoint, LogDetail logDetail) <span class="directive">throws</span> <span class="predefined-type">Throwable</span> {
    <span class="predefined-type">Object</span> target = joinPoint.getTarget();
    <span class="predefined-type">Object</span><span class="type">[]</span> args = joinPoint.getArgs();

    <span class="predefined-type">String</span> className = target.getClass().getName();
    <span class="predefined-type">String</span> methodName = joinPoint.getSignature().getName();
    <span class="predefined-type">StringBuilder</span> argBuilder = <span class="keyword">new</span> <span class="predefined-type">StringBuilder</span>();

    <span class="keyword">for</span> (<span class="predefined-type">Object</span> arg : args) {
      argBuilder.append(LogUtil.argValues(arg, <span class="integer">0</span>))
          .append(<span class="string"><span class="delimiter">&quot;</span><span class="char">\n</span><span class="delimiter">&quot;</span></span>);
    }
    <span class="predefined-type">String</span> argString = argBuilder.toString();

    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">invoke method {}${}</span><span class="delimiter">&quot;</span></span>, className, methodName);
    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">method arguments: {}</span><span class="delimiter">&quot;</span></span>, argString);

    <span class="predefined-type">Object</span> result  = joinPoint.proceed(args);

    logger.debug(<span class="string"><span class="delimiter">&quot;</span><span class="content">finish the method {}${}</span><span class="delimiter">&quot;</span></span>, className, methodName);

    <span class="keyword">return</span> result;
  }
}</code></pre></div></div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transactional</span>
<span class="annotation">@Override</span>
<span class="directive">public</span> TodoItem changeState(<span class="annotation">@NonNull</span> TodoItem todo, <span class="annotation">@NonNull</span> TodoState state) <span class="directive">throws</span> IllegalStateChangeException {
  TodoItem savedItem = <span class="local-variable">this</span>.getItem(todo.getIdx());

  <span class="directive">final</span> <span class="type">boolean</span> possibleToChangeState = TodoState.isPossibleToChangeState(savedItem.getState(), state);
  <span class="keyword">if</span> (not(possibleToChangeState)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateChangeException();
  }

  savedItem.setState(state);

  <span class="keyword">return</span> todoItemRepository.save(savedItem);
}</code></pre></div></div></div></div></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></article><br/><article id="post-2018/06/06/java-exception" class="post" role="article"><h1 class="post-title"> <a href="/2018/06/06/java-exception/"> Java Exception </a></h1><div class="post-date"> <time datetime="2018-06-06T00:00:00+00:00">2018/06/06/</time> <span>on <a href="/tag/java/">Java</a></span></div><hr/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="sect1"><h2 id="개요"><a class="link" href="#개요">1. 개요</a></h2><div class="sectionbody"><div class="paragraph"><p>자바 계통 언어에서는 오류를 표현하는 2가지 방법이 존재한다. 첫 번째는 <code>Error</code> 클래스인데 <code>Error</code> 클래스를 상속받는 하위 클래스는 시스템 오류를 표현하게 된다. 두 번째는 <code>Exception</code> 클래스로 어플리케이션 레벨에서 개발자가 예외사항을 표현하기 위해 사용한다.</div><div class="paragraph"><p>이번 포스팅에서는 <code>Error</code>와 <code>Exception</code>에 대해서 작성한다.</div></div></div><div class="sect1"><h2 id="error"><a class="link" href="#error">2. Error</a></h2><div class="sectionbody"><div class="paragraph"><p><code>Error</code> 클래스는 시스템 오류를 표현하는 것으로 주로 <code>JVM</code>에서 사용한다. 어플리케이션 레벨에서 사용하는 경우도 있기는 한데 거의 사용되지 않고, <code>try~catch</code>로 처리할 수 없다. 시스템 오류를 표현하는 것이므로 어플리케이션 개발자가 관여하게될 가능성이 매우 낮다. 흔히 볼 수 있는 <code>Error</code> 클래스의 구현체는 <code>OutOfMemoryError</code>와 <code>StackOverflowError</code>가 있다.</div></div></div><div class="sect1"><h2 id="exception"><a class="link" href="#exception">3. Exception</a></h2><div class="sectionbody"><div class="paragraph"><p><code>Exception</code> 클래스는 어플리케이션을 개발하는 과정에서 로직을 처리하는 중에 예외사항이 발생할 경우 사용하게 된다. <code>Exception</code>은 크게 <code>Checked Exception</code>과 <code>Unchecked Exception</code>으로 구분되는데 이 둘의 차이는 아래 표와 같다.</div><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 20%;"><col style="width: 40%;"><col style="width: 40%;"><thead><tr><th class="tableblock halign-left valign-top"><th class="tableblock halign-left valign-top">Checked Exception<th class="tableblock halign-left valign-top">Unchecked Exception<tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">명시적 처리<td class="tableblock halign-left valign-top"><p class="tableblock">명시적으로 처리해야 함<td class="tableblock halign-left valign-top"><p class="tableblock">명시적인 처리를 강요하지 않음<tr><td class="tableblock halign-left valign-top"><p class="tableblock">처리 시점<td class="tableblock halign-left valign-top"><p class="tableblock">Compile Time<td class="tableblock halign-left valign-top"><p class="tableblock">Application Runtime<tr><td class="tableblock halign-left valign-top"><p class="tableblock">대표 Class<td class="tableblock halign-left valign-top"><p class="tableblock">Exception 클래스와 하위 클래스 중 RuntimeException과 그 하위 클래스를 제외<td class="tableblock halign-left valign-top"><p class="tableblock">RuntimeException</table><div class="paragraph"><p>자바에서는 <code>Exception</code>을 처리하는 과정에서 <code>RuntimeException</code>과 그 하위 클래스들을 특별하게 취급하여 <code>Compile Time</code>에서 처리를 강제하지 않고, <code>Runtime</code>에서 처리한다.</div><div class="paragraph"><p>주로 개발자에게 예외사항이 발생할 수 있음을 알려주기 위하거나, 비즈니스 요구사항을 표현하기 위해서 <code>CheckedException</code>을 사용하게 된다. 반대로 <code>Unchecked Exception</code>은 반드시 처리하지 않아도 되는 경우나, 굳이 개발자가 알 필요가 없을 경우 사용하게 된다.</div><div class="paragraph"><p><code>Exception</code>을 사용하게 되면 비즈니스 로직에서 <code>true/false</code> 혹은 <code>object/null</code>을 사용하는 것에 비해서 훨씬 다양하게 예외사항을 표현할 수 있고, 비즈니스 요구사항을 코드로 깔끔하게 담을 수 있다. 또한 의미와 용도에 맞는 <code>Exception</code>을 다양하게 사용하게 된다면, 디버깅이나 유지부수에도 큰 이점을 가질 수 있다. <code>Exception</code>은 주로 분석/설계 단계에서 정의를 하게 된다. 실제 비즈니스 로직을 구현하면서 메소드에 <code>throws</code>를 명시적으로 작성함으로써 해당 메소드를 사용하는 개발자에게 예외사항이 발생할 수 있음을 열려준다.</div></div></div><div class="sect1"><h2 id="예시"><a class="link" href="#예시">4. 예시</a></h2><div class="sectionbody"><div class="paragraph"><p>어플리케이션을 개발하는 과정에서 요구사항을 분석하는 과정이 있고, 이 과정에서 <code>User Story</code>와 <code>Scenario</code>를 정의할 수 있다.</div><div class="paragraph"><p>예를 들어 TODO Item을 관리하는 어플리케이션에서 TODO의 상태를 변경하는 기능 요구사항이 있고, 요구사항 분석 결과 아래와 같은 <code>User Story</code>와 <code>Scenario</code>가 나왔다고 가정한다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="plain">User Story:
TODO Item의 상태를 변경할 수 있다.
Todo/Doing/Done으로 상태를 변경할 수 있고, 상태변경은 Todo &gt; Doing, Doing &gt; Done, Done &gt; Doing, Doing &gt; Todo 로만 할 수 있다.


Scenario 1: Todo에서 Doing으로 상태를 변경한다.
Scenario 2: Doing에서 Done으로 상태를 변경한다.
Scenario 3: Done에서 Doing으로 상태를 변경한다.
Scenario 4: Doing에서 Todo로 상태를 변경한다.
Scenario 5: Todo에서 Done으로 상태를 변경한다.
Scenario 6: Done에서 Todo로 상태를 변경한다.</code></pre></div></div><div class="paragraph"><p>위와 같이 <code>User Story</code>와 <code>Scenario</code>를 정의한다고 할 때 <code>Scenario 5</code>와 <code>Scenario 6</code>은 예외사항이 발생하는 <code>Scenario</code> 이다. 이렇게 분석 과정에서 예외사항이 발생할 수 있음을 미리 파악하고, 이를 설계 및 구현에서 반영을 하게 된다.</div><div class="paragraph"><p>위의 예시를 코드로 표현하면 아래와 같다.</div><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> TodoItem changeState(<span class="annotation">@NonNull</span> TodoItem todo, <span class="annotation">@NonNull</span> TodoState state) <span class="directive">throws</span> IllegalStateChangeException {
  TodoItem savedItem = todoItemRepository.findById(todo.getIdx())
      .orElseThrow(ResourceNotFoundException::<span class="keyword">new</span>);

  <span class="directive">final</span> <span class="type">boolean</span> possibleToChangeState = TodoState.isPossibleToChangeState(savedItem.getState(), state);
  <span class="keyword">if</span> (not(possibleToChangeState)) {
    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateChangeException();
  }

  savedItem.setState(state);

  <span class="keyword">return</span> todoItemRepository.save(savedItem);
}</code></pre></div></div><div class="paragraph"><p>위의 코드 예시와 같이 비즈니스 요구사항에 의한 예외사항은 <code>Checked Exception</code>으로 처리하여 <code>throws</code>를 통해 명시적으로 알려준다. 반면에 비즈니스 요구사항이 아닌, 해당 TODO Item이 없어서 처리할 수 없는 예외같은 경우는 <code>Unchecked Exception</code>을 통해 처리를 하면 된다.</div></div></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></article><br/><article id="post-2018/02/18/dockerfile" class="post" role="article"><h1 class="post-title"> <a href="/2018/02/18/dockerfile/"> Dockerfile </a></h1><div class="post-date"> <time datetime="2018-02-18T00:00:00+00:00">2018/02/18/</time> <span>on <a href="/tag/etc/">Etc</a></span></div><hr/> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script><div class="sect1"><h2 id="dockerfile"><a class="link" href="#dockerfile">1. Dockerfile?</a></h2><div class="sectionbody"><div class="paragraph"><p><code>Dockerfile</code>은 <code>Image</code> 설정 파일로 <code>Image</code>를 생성할 내용을 작성한다.</div></div></div><div class="sect1"><h2 id="docker-dockerfile-options"><a class="link" href="#docker-dockerfile-options">2. Options</a></h2><div class="sectionbody"><table class="tableblock frame-all grid-all stretch"><colgroup><col style="width: 20%;"><col style="width: 80%;"><thead><tr><th class="tableblock halign-left valign-top">Option<th class="tableblock halign-left valign-top">Description<tbody><tr><td class="tableblock halign-left valign-top"><p class="tableblock">FROM<td class="tableblock halign-left valign-top"><p class="tableblock">어떤 이미지를 기반으로 생성할지 설정한다. &lt;이미지 이름&gt;:&lt;태그&gt; 형식으로 설정한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">MAINTAINER<td class="tableblock halign-left valign-top"><p class="tableblock">메인테이너 정보를 작성한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">ENV<td class="tableblock halign-left valign-top"><p class="tableblock">이미지의 환경변수를 설정한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">RUN<td class="tableblock halign-left valign-top"><p class="tableblock">쉘 스크립트 혹은 명령어를 실행한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">VOLUME<td class="tableblock halign-left valign-top"><p class="tableblock">호스트와 공유할 디렉토리를 지정한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">CMD<td class="tableblock halign-left valign-top"><p class="tableblock">컨테이너가 시작됐을 때 실행할 실행 파일 혹은 쉘 스크립트를 지정한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">ADD<td class="tableblock halign-left valign-top"><p class="tableblock">호스트에서 이미지로 복사할 파일을 지정한다.<tr><td class="tableblock halign-left valign-top"><p class="tableblock">EXPOSE<td class="tableblock halign-left valign-top"><p class="tableblock">호스트와 연결할 포트 번호를 지정한다.</table></div></div><div class="sect1"><h2 id="example"><a class="link" href="#example">3. Example</a></h2><div class="sectionbody"><div class="listingblock"><div class="content"><pre class="CodeRay highlight"><code data-lang="docker">FROM centos:centos6.8
MAINTAINER HyeonilJeong &lt;dev.nuti0102@gmail.com&gt;

ENV V_NGINX=1.12.1 \
  V_TOMCAT=8.5.23 \
  DIR_CONTENTS=/opt/project/contents \
  STATIC_DOMAIN=http://static.nuti.pe.kr \
  VM_XMS=256m \
  VM_XMX=1024m \
  VM_XX_NEW_SIZE=384m \
  VM_XX_MAX_PERM_SIZE=128m \
  DB_HOST=db.nuti.pe.kr \
  DB_NAME=blog \
  DB_USERNAME=nuti \
  DB_PASSWORD=db_pw

RUN rpm --import /etc/pki/rpm-gpg/RPM* \
  &amp;&amp; yum update -y

ADD repos.d/nginx.repo /etc/yum.repos.d/nginx.repo

RUN yum install -y nginx $V_NGINX \
  &amp;&amp; rm -f /etc/nginx/conf.d/*.conf \
  &amp;&amp; yum install -y wget \
  &amp;&amp; rpm -Uvh  http://dl.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm \
  &amp;&amp; rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm

RUN yum install -y supervisor
RUN yum install -y java-1.8.0-openjdk-devel.x86_64
RUN mkdir -p $DIR_CONTENTS

ADD nginx/nginx.conf /etc/nginx/nginx.conf
ADD nginx/copy.conf /etc/nginx/conf.d/copy.conf
ADD supervisor/supervisord.conf /etc/supervisord.conf
ADD scripts/start.sh /scripts/start.sh
ADD tomcat /tomcat
ADD war/ROOT.war /tomcat/webapps/ROOT.war

RUN chmod +x /scripts/start.sh \
 &amp;&amp; chmod +x /tomcat/bin/startup-tomcat.sh

EXPOSE 80 8080

VOLUME $DIR_CONTENTS
VOLUME /tomcat/logs

CMD [&quot;/scripts/start.sh&quot;]</code></pre></div></div></div></div><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-1986785092914105" data-ad-slot="9021907658" data-ad-format="auto"></ins> <script> (adsbygoogle = window.adsbygoogle || []).push({}); </script></article><br/><h2 class="sr-only">Pagination</h2><nav class="pagination" role="navigation"><ul><li class="pagination-item older" > <a rel="next" href="/page-4">Older</a><li class="pagination-item newer" > <a rel="prev" href="/page-2">Newer</a></ul></nav></main><div id="_backdrop" class="backdrop"></div><header id="_sidebar" class="sidebar" role="banner"><div id="_asidebar" class="container sidebar-sticky"><div class="sidebar-about"><h1 class="font-accent"><a href="/">Hyeonil's Note</a></h1><p>Hyeonil’s Dev Note</div><nav class="sidebar-nav font-accent" role="navigation"><ul><li> <a class="sidebar-nav-item " href="/tag/all/">All</a><li> <a class="sidebar-nav-item " href="/tag/java/">Java</a><li> <a class="sidebar-nav-item " href="/tag/spring/">Spring</a><li> <a class="sidebar-nav-item " href="/tag/spec/">Specification</a><li> <a class="sidebar-nav-item " href="/tag/architecture/">Architecture</a><li> <a class="sidebar-nav-item " href="/tag/diary/">Diary</a><li> <a class="sidebar-nav-item " href="/tag/etc/">Etc</a><li> <a class="sidebar-nav-item " href="/about/">About</a></ul></nav><div class="sidebar-social"><ul><li> <a href="https://github.com/hyeonil"> <span class="fa fa-github"></span> <span class="sr-only">github</span> </a><li> <a href="https://nuti.tistory.com"> <span class="fa fa-external-link"></span> <span class="sr-only">blog</span> </a></ul></div></div></header><!--[if gt IE 8]><!----> <script>loadJSDeferred('/public/js/hydejack.min.js')</script> <script> WebFontConfig = { google: { families: 'Roboto+Slab:700|PT+Serif:400,400italic,700,700italic'.split('|') }, custom: { families: ['icomoon'], urls: ['/public/css/font-awesome.min.css'] }, classes: false, events: false }; </script> <script>loadJSDeferred('https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js')</script> <script> window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date; ga('create', 'UA-88066046-1', 'auto'); ga('send', 'pageview'); </script> <script>loadJSDeferred('https://www.google-analytics.com/analytics.js')</script> <!--<![endif]-->
